/******************************************************************************
**	@Author:				Thomas Bouder <Tbouder>
**	@Email:					Tbouder@protonmail.com
**	@Date:					Saturday March 6th 2021
**	@Filename:				checkYearnDaiExploit.js
******************************************************************************/

import	{ethers}		from	'ethers';
import	{bigNumber} 	from	'achievements/helpers'

/******************************************************************************
** _TX_: 0xf6022012b73770e7e2177129e648980a82aab555f9ac88b8a9cda3ec44b30779
** _BLOCK_: 11792260
** _DETAILS_: An exploit against Yearn’s v1 yDAI vault has led to 11m DAI of
**		vault deposits being lost. Acting in roughly 11 minutes, Yearn’s
**		security team and multi-sig wallet signers were able to stop the
**		exploit while it was underway, saving 24m DAI out of the vault’s
**		total 35m DAI deposits. By creating exchange rate imbalances in
**		Curve’s 3pool, an exploiter was able to cause Yearn’s yDAI vault to
**		deposit and withdraw funds from 3pool at unfavorable rates across a
**		series of transactions.
******************************************************************************/
const	YEARN_DAI_ADDRESS = '0xacd43e627e64355f1861cec6d3a6688b31a6f952';
const	YEARN_DAI_HACK_BLOCK = 11792260;
const 	ERC20_ABI = ['function balanceOf(address owner) view returns (uint256)'];

async function	checkYearnDaiExploit(provider, userAddress) {
	const	yearnDaiJSON = new ethers.Contract(YEARN_DAI_ADDRESS, ERC20_ABI, provider)
	let		balanceOnHackTime = undefined;

	try {
		balanceOnHackTime = await yearnDaiJSON.balanceOf(userAddress, {blockTag: YEARN_DAI_HACK_BLOCK});
	} catch (error) {
		console.dir(error)
		return {unlocked: false, informations: undefined};
	}

	if (!bigNumber.from(balanceOnHackTime).isZero()) {
		return {unlocked: true, informations: {
			blockNumber: YEARN_DAI_HACK_BLOCK,
			hash: '0xf6022012b73770e7e2177129e648980a82aab555f9ac88b8a9cda3ec44b30779',
			details: balanceOnHackTime,
			timestamp: 1612431092000,
		}};
	}
	return {unlocked: false, informations: undefined};
}

export default checkYearnDaiExploit;